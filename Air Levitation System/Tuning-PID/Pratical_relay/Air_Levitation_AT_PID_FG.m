%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
% Universidade Federal do Piauí                       %
% Campus Ministro Petronio Portela                    %
% Copyright 2022 -José Borges do Carmo Neto-          %
% @author José Borges do Carmo Neto                   %
% @email jose.borges90@hotmail.com                    %
%  PID controllers for the Phase                      %
%  and Gain Margins of the System                     % 
%                                                     %
%  -- Version: 1.0  - 30/04/2022                      %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

%% 1 - Tratando o processo:
Tamostra = 0.06
dh = 60;
dl = 47;
n = 200
eps = 10;

d=(dh-dl)/2

ep = eps

%% 2 - Aplicando o rele:

%u = [0, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47]
u = [0, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47, 47]
ref = 500*ones(size(u))
%y = [26, 31, 31, 26, 26, 35, 35, 42, 35, 31, 38, 81, 104, 168, 186, 196, 212, 233, 273, 300, 317, 332, 361, 387, 403, 434, 469, 509, 530, 556, 588, 610, 633, 651, 669, 690, 711, 729, 741, 754, 759, 775, 788, 791, 793, 786, 792, 797, 789, 793, 794, 783, 777, 776, 786, 788, 775, 779, 771, 776, 769, 769, 763, 761, 761, 752, 751, 745, 742, 737, 732, 734, 729, 718, 722, 714, 691, 690, 686, 679, 676, 670, 672, 665, 659, 654, 652, 643, 639, 630, 624, 616, 610, 606, 598, 596, 589, 586, 582, 577, 564, 556, 545, 540, 535, 527, 524, 522, 516, 509, 501, 496, 494, 489, 486, 478, 476, 466, 462, 454, 448, 442, 436, 430, 421, 418, 412, 408, 403, 398, 392, 391, 387, 384, 382, 385, 388, 391, 402, 410, 423, 438, 451, 467, 486, 506, 525, 550, 577, 598, 620, 639, 727, 743, 755, 766, 769, 779, 777, 779, 784, 781, 782, 782, 784, 779, 782, 780, 768, 768, 759, 748, 749, 735, 730, 722, 717, 706, 690, 691, 682, 673, 667, 658, 657, 650, 640, 624, 618, 603, 596, 592, 579, 579, 568, 573, 563, 561, 556, 553, 549, 526, 520, 517, 515, 512, 511, 506, 505, 498, 496, 496, 491, 488, 486, 480, 475, 469, 474, 469, 467, 466, 463, 457, 451, 447, 446, 448, 441, 440, 434, 433, 429, 429, 423, 418, 412, 411, 403, 397, 389, 387, 386, 387, 390, 393, 400, 410, 426, 434, 451, 467, 491, 516, 533, 560, 584, 606, 629, 645, 665, 680, 699, 714, 738, 745, 751, 753, 765, 764, 773, 777, 780, 774, 777, 771, 771, 758, 754, 749, 737, 736, 729, 724, 720, 714, 711, 711, 706, 701, 692, 684, 679, 674, 670, 669, 661, 659, 652, 651, 647, 636, 627, 617, 610, 601, 593, 580, 582, 574, 571, 569, 560, 552, 544, 536, 529, 525, 520, 518, 514, 501, 495, 489, 482, 473, 465, 457, 454, 452, 448, 441, 438, 435, 422, 421, 413, 410, 405, 400, 393, 388, 391, 387, 385, 390, 397, 404, 415, 420, 436, 441, 460, 482, 498, 522, 545, 569, 597, 617, 639, 668, 696, 716, 744, 773, 781, 794, 798, 807, 811, 806, 809, 810, 806, 793, 776, 769, 758, 734, 726, 716, 712, 708, 706, 699, 691, 688, 685, 677, 676, 670, 666, 659, 658, 650, 648, 640, 627, 621, 616, 610, 606, 600, 596, 590, 582, 583, 577, 578, 564, 563, 556, 544, 536, 517, 518, 516, 506, 502, 500, 498, 493, 489, 486, 483, 479, 475, 471, 465, 457, 455, 453, 445, 436, 432, 432, 427, 416, 413, 405, 397, 392, 385, 381, 380, 376, 378, 382, 385, 390, 398, 405, 418, 430, 440, 455, 467, 488, 507, 530, 552, 580, 601, 620, 642, 677, 697, 712, 721, 735, 747, 748, 753, 751, 761, 765, 762, 764, 760, 761, 761, 753, 751, 750, 749, 749, 744, 740, 733, 724, 720, 720, 715, 706, 697, 696, 690, 690, 684]
y  = [26, 27, 30, 28, 30, 27, 29, 29, 28, 28, 30, 28, 33, 31, 33, 34, 38, 31, 26, 33, 41, 41, 65, 80, 96, 108, 122, 125, 147, 160, 177, 205, 221, 235, 249, 264, 278, 298, 307, 326, 340, 352, 367, 374, 404, 421, 432, 452, 474, 493, 520, 539, 555, 588, 611, 619, 652, 674, 690, 699, 702, 710, 719, 731, 727, 725, 725, 734, 728, 720, 719, 718, 711, 700, 694, 690, 684, 677, 669, 659, 655, 645, 644, 632, 622, 616, 604, 594, 593, 580, 571, 563, 551, 542, 532, 525, 514, 508, 497, 488, 474, 466, 460, 451, 438, 428, 417, 408, 401, 393, 385, 377, 368, 359, 356, 351, 348, 348, 351, 353, 359, 372, 379, 385, 395, 410, 419, 436, 453, 465, 484, 497, 517, 532, 550, 569, 592, 609, 626, 647, 665, 677, 693, 704, 711, 720, 729, 731, 740, 747, 746, 746, 743, 751, 750, 753, 745, 719, 710, 707, 627, 552, 356, 317, 338, 378, 487, 594, 609, 760, 788, 832, 831, 827, 819, 813, 812, 806, 797, 789, 783, 774, 769, 757, 743, 733, 730, 715, 704, 691, 679, 676, 666, 659, 649, 643, 632, 625, 613, 614, 604, 594, 589, 577, 566, 560, 545, 536, 531, 523, 516, 509, 499, 489, 480, 476, 467, 459, 451, 442, 437, 426, 415, 407, 396, 388, 381, 377, 369, 361, 356, 351, 354, 360, 366, 376, 384, 395, 409, 423, 446, 463, 478, 507, 533, 566, 585, 633, 662, 688, 701, 712, 723, 731, 748, 754, 766, 775, 773, 773, 777, 774, 769, 761, 757, 751, 743, 737, 726, 724, 711, 708, 697, 688, 682, 677, 671, 662, 651, 637, 631, 621, 612, 601, 596, 586, 578, 571, 563, 552, 541, 530, 526, 517, 504, 496, 487, 473, 464, 455, 450, 442, 433, 427, 417, 405, 400, 387, 377, 374, 367, 370, 372, 377, 382, 391, 403, 417, 422, 432, 444, 461, 476, 492, 511, 544, 565, 585, 600, 624, 642, 666, 689, 701, 720, 735, 743, 745, 756, 755, 755, 755, 751, 748, 743, 735, 733, 724, 717, 710, 700, 695, 688, 680, 669, 658, 649, 639, 628, 616, 607, 597, 588, 580, 575, 562, 556, 540, 528, 521, 510, 502, 492, 485, 475, 464, 454, 443, 434, 429, 413, 400, 392, 382, 374, 370, 364, 363, 365, 370, 376, 391, 397, 408, 421, 436, 460, 496, 514, 538, 565, 584, 598, 623, 635, 652, 672, 689, 709, 720, 744, 753, 764, 763, 768, 762, 757, 749, 719, 713, 709, 703, 695, 686, 674, 663, 661, 651, 639, 629, 602, 585, 580, 568, 561, 552, 545, 539, 531, 525, 514, 505, 502, 493, 487, 475, 463, 456, 448, 440, 435, 421, 413, 402, 394, 388, 377, 363, 357, 348, 348, 353, 355, 359, 361, 373, 386, 395, 406, 419, 430, 444, 455, 482, 499, 518, 534, 552, 575, 596, 620, 640, 658, 674, 694, 707, 727, 736, 748, 759, 764, 769, 781, 787, 786, 786, 789, 791, 786, 788, 786, 783, 777, 778, 774, 768, 761, 757, 746, 743, 741, 731, 725, 720, 717, 708, 706, 695, 690, 685, 676, 672, 662, 659, 653, 645, 634, 624, 622, 610, 603, 590, 588, 580, 576, 568, 560, 552, 546, 528, 522, 487, 467, 448, 426, 413, 398, 380, 361, 364, 412, 464, 503, 529, 570, 613, 627, 652, 686, 712, 760, 769, 769, 766, 763, 764, 759, 752, 744, 741, 737, 734, 731, 719, 717, 710, 706, 698, 689, 679, 672, 662, 656, 649, 637, 626, 626, 617, 610, 603, 598, 588, 582, 574, 564, 559, 554, 544, 534, 531, 522, 508, 502, 495, 487, 480, 471, 466, 459, 451, 440, 435, 428, 420, 409, 402, 396, 387, 381, 376, 368, 367, 365, 363, 375, 388, 415, 454, 469, 504, 537, 561, 577, 598, 620, 635, 656, 669, 690, 701, 716, 726, 736, 743, 751, 758, 759, 765, 766, 769, 774, 774, 776, 773, 776, 776, 770, 763, 762, 754, 751, 743, 738, 729, 719, 710, 711, 703, 696, 689, 681, 675, 666, 660, 646, 638, 631, 620, 611, 602, 593, 583, 576, 564, 549, 539, 531, 520, 509, 503, 498, 487, 482, 473, 461, 458, 446, 438, 430, 421, 410, 400, 395, 385, 383, 374, 368, 365, 366, 372, 369, 374, 379, 383, 398, 407, 417, 427, 443, 459, 474, 487, 506, 522, 537, 556, 573, 592, 607, 633, 649, 672, 694, 711, 728, 741, 746, 760, 760, 765, 769, 769, 764, 761, 756, 755, 747, 746, 738, 729, 723, 717, 710, 706, 698, 694, 683, 676, 664, 656, 641, 632, 625, 615, 602, 595, 586, 580, 570, 562, 552, 544, 537, 528, 513, 506, 498, 489, 479, 468, 455, 444, 434, 422, 408, 399, 387, 374, 364, 359, 359, 367, 378, 388, 397, 406, 422, 465, 481, 499, 523, 542, 559, 574, 597, 617, 641, 661, 681, 694, 705, 712, 727, 736, 744, 743, 739, 743, 739, 732, 732, 733, 722, 718, 716, 714, 704, 697, 691, 694, 686, 678, 665, 657, 654, 640, 635, 631, 621, 612, 608, 594, 588, 583, 570, 562, 551, 543, 535, 527, 520, 509, 501, 492, 487, 479, 471, 462, 457, 442, 428, 395, 366, 356, 347, 340, 343, 353, 363, 375, 385, 397, 408, 427, 448, 474, 497, 519, 549, 573, 595, 622, 647, 674, 695, 719, 739, 742, 762, 770, 774, 781, 787, 789, 795, 798, 794, 790, 786, 785, 774, 769, 761, 759, 755, 746, 742, 736, 730, 721, 716, 706, 696, 687, 679, 669, 667, 659, 648, 637, 633, 617, 610, 610, 603, 598, 588, 585, 578, 571, 563, 556, 546, 539, 532, 523, 516, 508, 503, 493, 487, 476, 468, 463, 452, 447, 439, 432, 425, 417, 407, 399, 391, 379, 372, 365, 363, 360, 367, 370, 377, 386, 395, 408, 425, 445, 459, 480, 492, 510, 528, 546, 563, 584, 597, 620, 633, 650, 667, 679, 695, 709, 718, 736, 746, 757, 762, 770, 772, 778, 779, 767, 777, 766, 760, 761, 757, 748, 750, 737]

Qde_amostras = size(u,2)
nptos = Qde_amostras
t = 1:1:Qde_amostras
Tempo = Tamostra*t
%%
plot(y)
hold on
plot(u)
%% 3 Identificar os parametros a partir do experimento com relé:

    %[gw,w,arm,Kp]=Identificar(n, d, eps,Tamostra,y,u);
    
  maxi=max(y(nptos/2:end));
  mini=min(y(nptos/2:end));
  d=(dh-dl)/2
  a=(maxi-mini)/2
  img=((pi*ep)/(4*d))
  real=((-pi)/(4*d))*sqrt((a^2)-(ep^2))
  g=real-j*img

kont = 0;
for t = 4:Qde_amostras,
   if u(t) ~= u(t-1)
      kont = kont + 1;
      ch(kont) = t;
   end
end
Tu1 = (ch(3) - ch(2))*Tamostra
Tu2 = (ch(4) - ch(3))*Tamostra
Tu = Tu1 + Tu2
w = (2*pi)/(Tu)

% --- Calcula valor de pico positivo
amp_max = eps;
for t =1:Qde_amostras,
   if y(t) >= amp_max  amp_max = y(t); end;
end;
%%
num = 0;
den = 0;
for j=(n/2):(n/2)+ceil(Tu),
    num = num + y(j);
    den = den + u(j);
end
Kp = num/den
  %******************Calculo ganho e fase do processo*******
gw=-(pi*sqrt(a^2-eps^2))/(4*d)
%%
    Ku = -1/gw;
    %Tu = (2*pi)/w; 

    L = 1;
   
    c = 1/Kp;
    b = sin(w*L)/(w*Ku);
    a = (c + cos(w*L))/(w^2);
    
%% 3.1 teste modelo:
a1 = -0.955255265000912
a2 = -0.029363939258160
b1 = 0.026243849901936
b2 = 0.274777441417530
%% Definições do controlador AT-PID-FG: 
%     Am_min = 2; 
%     Am_max = 5;
%     Theta_m_min = 45;
%     Theta_m_max = 72;
%% Sintonizanodo o PID:
    Am = 3;
    Theta_m = (180/2)*(1-(1/Am));
    
    K = (pi/(2*Am*L))*[b;c;a];
    Kc = K(1);
    Ki = K(2);
    Kd = K(3);
    K
    
%%
Ti = Kc/Ki
Td = Kd/Kc


%% Aplicando o controlador - OLD version
for i=1:nptos,
    if (i<=nptos/2)  ref(i)=100; end;
    if (i>nptos/2)   ref(i) = 500; end;
end ;

y(4)=0 ; y(3)=0 ; y(2)=0 ; y(1)=0 ; 
u(1)=0 ; u(2)=0 ; u(3)=0; u(4)=0;

erro(1)=1 ; erro(2)=1 ; erro(3)=1; erro(4)=1;

rlevel = 0.0;
ruido = rlevel*rand(1,nptos);

for i=5:nptos,


    
%[c0,c1,c2,r0,r1,r2] = discretiza_zoh(P1(i),P2(i),k,Tc); %chama a função que discretiza o processo utilizano um ZOH;

    % if (i==550),r1 = - 1.84;r2 = 0.9109;  end % Ruptura no modelo
     y(i) = -a1*y(i-1)-a2*y(i-2)+b1*u(i-1)+b2*u(i-2);
     %y(i)= -r1*y(i-1)-r2*y(i-2)+c0*u(i-2)+c1*u(i-3)+c2*u(i-4); % equação da diferença do processo
     
     erro(i)=ref(i)-y(i); %Erro
      
             %Controlador:

%             alpha = (Kc)*(1+((Td)/Tamostra)+(Tamostra/(2*(Ti))));
%             beta = -(Kc)*(1+2*((Td)/Tamostra)-(Tamostra/(2*(Ti))));
%             gama = (Kc)*(Td)/Tamostra;
            
            % new version
            alpha = Kc+ Kd/Tamostra + (Ki*Tamostra)/2;
            beta = -(Kc) - 2*((Kd)/Tamostra)+(Ki*Tamostra)/2;
            gama = (Kd)/Tamostra;


            u(i)= u(i-1) + alpha*erro(i) + beta*erro(i-1) + gama*erro(i-2);
      
       tempo(i)=i*Tamostra;
      fprintf('amostra:  %d \t entrada:  %6.3f \t saida:  %4.0f\n',i,u(i),y(i));
      
 end ;
 
 
     ISE_t2 = objfunc(erro,tempo,'ISE')
     ITSE_t2 = objfunc(erro,tempo,'ITSE')
     ITAE_t2 = objfunc(erro,tempo,'ITAE')
     IAE_t2 = objfunc(erro,tempo,'IAE')
     
%plotar seinal de saida e  de controle:    
% figure;
% grid;
plot(tempo,y,'r-');
hold on;
plot(tempo,u);
plot(tempo,ref);
title(['AT-PID-FG:',num2str(rlevel), ' ISE:', num2str(ISE_t2), ', ITSE:' ,num2str(ITSE_t2),', IAE:' ,num2str(IAE_t2), ', ITAE:' ,num2str(ITAE_t2)])
%%
% %plotar P1 e P2
% figure;
% grid;
% plot(tempo,P1,'g-');
% hold on;
% plot(tempo,P2);

